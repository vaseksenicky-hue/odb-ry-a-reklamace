{% extends 'base.html' %}

{% block title %}{{ pobocka.nazev }}{% endblock %}

{% block content %}
<h1 class="text-center mb-4 fw-bold" style="font-size: 1.75rem; letter-spacing: -0.03em;">{{ pobocka.nazev }}</h1>

<div class="card card-apple mb-4">
    <div class="card-body p-4">
        <h5 class="card-title fw-semibold mb-3">Přehled odběrů</h5>
        <p class="mb-1"><strong>Celkem aktivních odběrů:</strong> {{ prehled.celkem }}</p>
        <p class="mb-1"><strong>Zelené (≤7 dní):</strong> <span class="text-success">{{ prehled.zelene }}</span></p>
        <p class="mb-0"><strong>Červené (>7 dní):</strong> <span class="text-danger">{{ prehled.cervene }}</span></p>
    </div>
</div>

<div class="card card-apple mb-4">
    <div class="card-body p-4">
        <h5 class="card-title fw-semibold mb-3">Přidat nový odběr</h5>
        {% if validacni_chyba %}
        <div class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>{{ validacni_chyba }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}
        <form method="POST" id="odberForm">
            {{ form.hidden_tag() }}
            <div class="row">
                <div class="col-md-6 mb-3">
                    {{ form.jmeno.label(class="form-label") }} <span class="text-danger">*</span>
                    {{ form.jmeno(class="form-control", required=True) }}
                    {% if form.jmeno.errors %}<div class="text-danger small mt-1">{% for e in form.jmeno.errors %}{{ e }}{% endfor %}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    {{ form.datum.label(class="form-label") }}
                    {{ form.datum(class="form-control", type="date") }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    {{ form.telefon.label(class="form-label") }} <span class="text-danger">*</span>
                    <div class="input-group">
                        <span class="input-group-text">+420</span>
                        <input type="text" name="telefon" class="form-control" id="telefon" maxlength="9" placeholder="123456789" pattern="[0-9]{9}" title="9 číslic" value="{{ form.telefon.data or '' }}" required>
                    </div>
                    {% if form.telefon.errors %}<div class="text-danger small mt-1">{% for e in form.telefon.errors %}{{ e }}{% endfor %}</div>{% endif %}
                </div>
                <div class="col-md-6 mb-3">
                    {{ form.castka.label(class="form-label") }}
                    {{ form.castka(class="form-control", type="number", step="0.01", min="0", id="castka") }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    {{ form.placeno_predem.label(class="form-label") }}
                    {{ form.placeno_predem(id="placeno_predem") }}
                </div>
                <div class="col-md-6 mb-3">
                    {{ form.poznamky.label(class="form-label") }}
                    {{ form.poznamky(class="form-control") }}
                </div>
            </div>
            {# Zadavatel se vyplní automaticky podle přihlášeného uživatele #}
            {{ form.kdo_zadal() }}
            <button type="submit" class="btn btn-primary w-100 rounded-pill py-2">Přidat</button>
        </form>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0 fw-semibold" style="font-size: 1.35rem; letter-spacing: -0.02em;">Aktivní odběry</h3>
    <a href="{{ url_for('reklamace_branch', pobocka_id=pobocka.id) }}" class="btn btn-outline-primary btn-sm">
        Reklamace na této pobočce
    </a>
</div>
<div class="card card-apple overflow-hidden">
    <div class="table-responsive">
        <table class="table table-bordered table-hover mb-0" id="odbery-table">
            <thead>
                <tr>
                    <th class="sortable" data-sort="jmeno">Jméno</th>
                    <th class="sortable" data-sort="kdo_zadal">Zadal</th>
                    <th class="sortable" data-sort="datum">Datum</th>
                    <th>Telefon</th>
                    <th>Částka</th>
                    <th>Poznámky</th>
                    <th>Akce</th>
                </tr>
            </thead>
            <tbody>
            {% for odber in odbery %}
            <tr class="{{ odber.barva }}" data-id="{{ odber.id }}">
                <td>{{ odber.jmeno }}</td>
                <td>{{ odber.kdo_zadal }}</td>
                <td>{{ odber.datum.strftime('%d.%m.%Y') }}</td>
                <td>
                    {% if odber.telefon %}
                        {% set telefon_str = odber.telefon|string %}
                        {% if telefon_str.startswith('+') %}
                            {{ telefon_str[:4] }} {{ telefon_str[4:7] }} {{ telefon_str[7:10] }} {{ telefon_str[10:] }}
                        {% else %}
                            +{{ telefon_str[:3] }} {{ telefon_str[3:6] }} {{ telefon_str[6:9] }} {{ telefon_str[9:] }}
                        {% endif %}
                    {% else %}
                        Není zadán
                    {% endif %}
                </td>
                <td>{% if odber.placeno_predem %}Placeno předem{% else %}{{ odber.castka|default(0) }} Kč{% endif %}</td>
                <td>
                    <span class="notes-text {% if not odber.poznamky %}empty{% endif %}" data-id="{{ odber.id }}">
                        {{ odber.poznamky|default('Žádné poznámky') }}
                    </span>
                    <a href="#" class="edit-notes-btn" data-id="{{ odber.id }}">Upravit</a>
                    <textarea class="form-control poznamky-text" data-id="{{ odber.id }}" rows="2" style="display: none;">{{ odber.poznamky|default('') }}</textarea>
                </td>
                <td>
                    <div class="d-flex gap-1">
                        <form action="{{ url_for('update', id=odber.id) }}" method="POST" class="action-form">
                            <input type="hidden" name="action" value="vydano">
                            <button type="submit" class="btn btn-success btn-sm">Vydáno</button>
                        </form>
                        <form action="{{ url_for('update', id=odber.id) }}" method="POST" class="action-form">
                            <input type="hidden" name="action" value="nevyzvednuto">
                            <button type="submit" class="btn btn-warning btn-sm">Nevyzvednuto</button>
                        </form>
                        <form action="{{ url_for('update', id=odber.id) }}" method="POST" class="action-form">
                            <input type="hidden" name="action" value="smazat">
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Opravdu chcete smazat tento odběr? Tato akce je nevratná!');">Smazat</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='main.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var odberForm = document.getElementById('odberForm');
        if (odberForm) {
            odberForm.addEventListener('submit', function(e) {
                var jmeno = (this.querySelector('input[name="jmeno"]') || {}).value || '';
                var telefon = (this.querySelector('input[name="telefon"]') || {}).value || '';
                if (!jmeno.trim()) { e.preventDefault(); alert('Zadejte jméno zákazníka.'); return false; }
                if (!/^\d{9}$/.test(telefon.replace(/\s/g, ''))) { e.preventDefault(); alert('Zadejte platné telefonní číslo (9 číslic).'); return false; }
            });
        }
        // Form functionality
        const placenoPredem = document.querySelector('#placeno_predem');
        const castka = document.querySelector('#castka');
        if (placenoPredem && castka) {
            placenoPredem.addEventListener('change', function() {
                castka.disabled = this.checked;
                if (this.checked) castka.value = '';
            });
            if (placenoPredem.checked) castka.disabled = true;
        }

        if (castka) castka.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9.]/g, '');
            const parts = this.value.split('.');
            if (parts.length > 2) {
                this.value = parts[0] + '.' + parts[1];
            }
        });

        // Notes functionality
        document.querySelectorAll('.edit-notes-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const id = this.dataset.id;
                const notesText = document.querySelector(`.notes-text[data-id="${id}"]`);
                const textarea = document.querySelector(`.poznamky-text[data-id="${id}"]`);
                notesText.style.display = 'none';
                this.style.display = 'none';
                textarea.style.display = 'block';
                textarea.focus();
            });
        });

        document.querySelectorAll('.poznamky-text').forEach(textarea => {
            textarea.addEventListener('blur', function() {
                saveNotes(this);
            });
            textarea.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    this.blur();
                }
            });
        });

        function saveNotes(textarea) {
            const id = textarea.dataset.id;
            const poznamky = textarea.value.trim();
            const notesText = document.querySelector(`.notes-text[data-id="${id}"]`);
            const editBtn = document.querySelector(`.edit-notes-btn[data-id="${id}"]`);
            
            console.log('Saving notes for ID:', id, 'Notes:', poznamky);
            
            $.ajax({
                url: '/update_notes/' + id,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ poznamky: poznamky }),
                success: function(data) {
                    console.log('Save notes response:', data);
                    if (data.status === 'success') {
                        notesText.textContent = poznamky || 'Žádné poznámky';
                        notesText.classList.toggle('empty', !poznamky);
                        notesText.style.display = 'inline';
                        editBtn.style.display = 'inline';
                        textarea.style.display = 'none';
                        $(textarea).addClass('notes-saving');
                        setTimeout(() => $(textarea).removeClass('notes-saving'), 1000);
                        const flashMessage = $('<div class="alert alert-success alert-dismissible fade show">Poznámky uloženy!<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');
                        $('.container').prepend(flashMessage);
                        setTimeout(() => flashMessage.fadeOut('slow'), 10000);
                    } else {
                        console.error('Save notes failed:', data.message);
                        alert('Chyba: ' + data.message);
                    }
                },
                error: function(xhr) {
                    const message = xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : 'Neznámá chyba';
                    console.error('AJAX error:', message, xhr);
                    alert('Chyba při ukládání poznámek: ' + message);
                }
            });
        }

        // Action forms
        document.querySelectorAll('.action-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const row = this.closest('tr');
                row.classList.add('removing');
                setTimeout(() => {
                    this.submit();
                }, 500);
            });
        });

        // Table sorting
        const table = document.getElementById('odbery-table');
        const headers = table.querySelectorAll('.sortable');
        headers.forEach(header => {
            header.addEventListener('click', () => {
                const sortKey = header.dataset.sort;
                const sortDirection = header.classList.contains('asc') ? 'desc' : 'asc';
                
                headers.forEach(h => {
                    h.classList.remove('asc', 'desc');
                });
                header.classList.add(sortDirection);

                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));

                rows.sort((a, b) => {
                    let aValue, bValue;
                    if (sortKey === 'datum') {
                        aValue = new Date(a.cells[2].textContent.split('.').reverse().join('-'));
                        bValue = new Date(b.cells[2].textContent.split('.').reverse().join('-'));
                    } else {
                        aValue = a.cells[sortKey === 'jmeno' ? 0 : 1].textContent.toLowerCase();
                        bValue = b.cells[sortKey === 'jmeno' ? 0 : 1].textContent.toLowerCase();
                    }
                    if (sortDirection === 'asc') {
                        return aValue > bValue ? 1 : -1;
                    } else {
                        return aValue < bValue ? 1 : -1;
                    }
                });

                while (tbody.firstChild) {
                    tbody.removeChild(tbody.firstChild);
                }
                rows.forEach(row => tbody.appendChild(row));
            });
        });
    });
</script>
{% endblock %}